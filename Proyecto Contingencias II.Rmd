---
title: "proyecto_contingencias_ii"
output: html_document
---

# Preparación inicial

Inicialmente, se importan las librerías requeridas para el proyecto.

```{r librerias}
pacman::p_load(dplyr,
               ggplot2,
               readxl)
```

## Fuerzas de mortalidad

Se obtienen las tablas con los parámetros de las fuerzas de mortalidad para cada edad.

```{r tablas_mux}
# Se importa la tabla masculina de intensidades graduales a estados de restricción de actividad central
hombres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_estados_restr")

# Se importa la tabla femenina de intensidades graduales a estados de restricción de actividad central
mujeres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_estados_restr")

# Se importa la tabla masculina transiciones graduales de recuperación
hombres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_recuperación")

# Se importa la tabla femenina transiciones graduales de recuperación
mujeres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_recuperación")

# Se importa la tabla masculina intensidades de transición graduales de mortalidad
hombres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "h_mortalidad")

# Se importa la tabla femenina intensidades de transición graduales de mortalidad
mujeres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "m_mortalidad")
```

Se procede con las funciones para obtener las fuerzas de mortalidad, inicialmente, con las fuerzas que transicionan de los estados en donde el individuo se encuentra con vida hacia adelante ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i < j$).

```{r mu_transicion}
# Función para obtener las intensidades de transición graduales a estados de restricción de actividad central
# x: edad
# tabla: hombres_restr o mujeres_restr
# mu: mu_12, mu_13, mu_14, mu_15, mu_23, mu_24, mu_25, mu_34, mu_35 o mu_45
restr_act_central <- function(x, tabla, mu) {
  # Se separan los casos para edades menores a 65
  if (x <= 65) {
    valor_mu <-
      (tabla[[mu]][1] + tabla[[mu]][2] * (tabla[[mu]][3]) ^ x) / (1 + tabla[[mu]][4] * (tabla[[mu]][3]) ^
                                                                    x + tabla[[mu]][5] * (tabla[[mu]][3]) ^ (-x)) + tabla[[mu]][6]
  } else {
    valor_mu <-
      tabla[[mu]][8] * (x - 65) ^ 5 + tabla[[mu]][9] * (x - 65) ^ 4 + tabla[[mu]][10] * (x - 65) ^
      3 + tabla[[mu]][11] * (x - 65) ^ 2 + tabla[[mu]][12] * (x - 65) + tabla[[mu]][13]
    
  }
  
  return(valor_mu)
  
}

(prueba_1h <- restr_act_central(20, hombres_restr, "mu_12"))
(prueba_1m <- restr_act_central(21, mujeres_restr, "mu_12"))
```

Seguidamente, la función para obtener las fuerzas de recuperación ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i > j$).

```{r mu_recuperacion}
# Función para calcular las intensidades de transición graduales a recuperación
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_21, mu_32, mu_43 o mu_54
recuperacion <- function(x, tabla, mu) {
  valor_mu <-
    (tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x)) / (1 + tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x))
  
  return(valor_mu)
}

(prueba_2h <- recuperacion(20, hombres_recup, "mu_21"))
(prueba_2m <- recuperacion(21, mujeres_recup, "mu_21"))
```

Luego, la función para obtener las fuerzas de transición hacia la muerte ($\mu_{x}^{i6} \hspace{0.5cm} \forall i \in \{1, 2, \dots, 5\}$).

```{r mu_muerte}
# Función para calcular las intensidades de transición graduales a mortalidad
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_16, mu_26, mu_36, mu_46 o mu_56
mortalidad <- function(x, tabla, mu) {
  valor_mu <-
    tabla[[mu]][1] + tabla[[mu]][2] * x + exp(tabla[[mu]][3] + tabla[[mu]][4] * x)
  
  return(valor_mu)
  
}

(prueba_3h <- mortalidad(20, hombres_mort, "mu_16"))
(prueba_3m <- mortalidad(21, mujeres_mort, "mu_16"))
```

## Probabilidades de transición

Se obtienen las tablas con las probabilidades de transición expuestas en el paper.

```{r prob_transicion, warning = FALSE, message = FALSE}
# Importar tablas con probabilidades de transición
hombres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "h_prob_transicion")
mujeres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "m_prob_transicion")
```

Se modifican los nombres de las columnas correspondientes.

```{r nombres_transicion}
colnames(hombres_prob_transicion)[1:2] <- c("Edad", "Capaz")
colnames(mujeres_prob_transicion)[1:2] <- c("Edad", "Capaz")
```

Se obtienen, por separado, las probabilidades de transición de cada estado. Esto quiere decir que el índice de la lista coincide con el estado correspondiente, por ejemplo, prob_hombres[[2]] coincide con el estado leve (2).

Junto a lo anterior, en el paper se menciona que no todas las filas suman 1, por lo cual, se hará una corrección uniforme a cada edad para que los modelos tengan sentido.

```{r corrección_probabilidades}
# Se crea una lista para las probabilidades de cada sexo
prob_hombres <- list()
prob_mujeres <- list()

# Se itera para separar las probabilidades por estados
for (i in c(1:6)) {
  prob_hombres[[i]] <-
    as.data.frame(hombres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  prob_mujeres[[i]] <-
    as.data.frame(mujeres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  
  # Se pone la edad en el nombre de fila de cada DataFrame
  rownames(prob_hombres[[i]]) <- seq(20, 80, 10)
  rownames(prob_mujeres[[i]]) <- seq(20, 80, 10)
  
  # Se elimina la columna de edad
  prob_hombres[[i]] <- prob_hombres[[i]] %>%
    select(-Edad)
  prob_mujeres[[i]] <- prob_mujeres[[i]] %>%
    select(-Edad)
}

# Obtenemos la suma de las filas en cada matriz
suma_hombres <- sapply(prob_hombres, rowSums)
suma_mujeres <- sapply(prob_mujeres, rowSums)

# Corregimos las filas que no suman 1
for (i in 1:length(prob_hombres)) {
  # Se separan los casos especiales
  if (i != 3 && i != 4) {
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 6)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 6)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- prob_hombres[[i]] + correccion_hombres
    prob_mujeres[[i]] <- prob_mujeres[[i]] + correccion_mujeres
  } else if(i == 3){
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 5)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 5)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1], prob_hombres[[i]][2:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1], prob_mujeres[[i]][2:6] + correccion_mujeres)
  } else{
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 4)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 4)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1:2], prob_hombres[[i]][3:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1:2], prob_mujeres[[i]][3:6] + correccion_mujeres)
  }
}

# Se eliminan las variables innecesarias
rm(correccion_hombres, correccion_mujeres, suma_mujeres, suma_hombres)
```

Con las probabilidades corregidas, se continúa obteniendo las probabilidades de transición intermedias, para edades de 18 a 115, usando el supuesto de fuerza de mortalidad constante.

```{r probabilidades_intermedias}
# Recorremos cada estado
for (i in 1:6) {
  # Iniciamos encontrando las pendientes
  pendientesh <-
    (prob_hombres[[i]][2:7,] - prob_hombres[[i]][1:6,]) / 10
  pendientesm <-
    (prob_mujeres[[i]][2:7,] - prob_mujeres[[i]][1:6,]) / 10
  
  # Listas para guardar las columnas
  lista_colsh <- list()
  lista_colsm <- list()
  lista_auxh <- list()
  lista_auxm <- list()
  
  # Construimos cada columna
  for (j in 1:6) {
    # Probabilidades de los hombres
    lista_colsh[[1]] <-
      prob_hombres[[i]][1, j] + pendientesh[1, j] * -2:9
    lista_colsh[[2]] <-
      prob_hombres[[i]][2, j] + pendientesh[2, j] * 0:9
    lista_colsh[[3]] <-
      prob_hombres[[i]][3, j] + pendientesh[3, j] * 0:9
    lista_colsh[[4]] <-
      prob_hombres[[i]][4, j] + pendientesh[4, j] * 0:9
    lista_colsh[[5]] <-
      prob_hombres[[i]][5, j] + pendientesh[5, j] * 0:9
    lista_colsh[[6]] <-
      prob_hombres[[i]][6, j] + pendientesh[6, j] * 0:45
    
    # Probabilidades de las mujeres
    lista_colsm[[1]] <-
      prob_mujeres[[i]][1, j] + pendientesm[1, j] * -2:9
    lista_colsm[[2]] <-
      prob_mujeres[[i]][2, j] + pendientesm[2, j] * 0:9
    lista_colsm[[3]] <-
      prob_mujeres[[i]][3, j] + pendientesm[3, j] * 0:9
    lista_colsm[[4]] <-
      prob_mujeres[[i]][4, j] + pendientesm[4, j] * 0:9
    lista_colsm[[5]] <-
      prob_mujeres[[i]][5, j] + pendientesm[5, j] * 0:9
    lista_colsm[[6]] <-
      prob_mujeres[[i]][6, j] + pendientesm[6, j] * 0:45
    
    # Obtenemos el dataframe
    lista_auxh[[j]] <- unlist(lista_colsh)
    lista_auxm[[j]] <- unlist(lista_colsm)
  }
  
  # Se extraen los dataframes en las probabilidades
  prob_hombres[[i]] <- data.frame(lista_auxh, row.names = 18:115)
  prob_mujeres[[i]] <- data.frame(lista_auxm, row.names = 18:115)
  colnames(prob_hombres[[i]]) <-
    c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
  colnames(prob_mujeres[[i]]) <-
    c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
}

# Se eliminan las variables innecesarias
rm(pendientesh,
   pendientesm,
   lista_auxh,
   lista_auxm,
   lista_colsh,
   lista_colsm)
```

Posteriormente, se procede a obtener las probabilidades de transición de varios pasos, esto para el cálculo de las primas. La fórmula correspondiente viene dada por:

$$_{k}p_{x} ^ {0j} = \sum_{i = 0} ^ {5} {}_{k - 1}p_{x} ^ {0i} \cdot p_{x + k - 1} ^ {ij}, \hspace{0.3cm} k \geq 2 \hspace{0.1cm} \wedge \hspace{0.1cm} j \in \{0, 1, \dots, 5\}$$

```{r probabilidades_mayores}
# Función para calcular los kpx^{1j}
# edad: edad del individuo (x)
# tabla_prob: prob_hombres o prob_mujeres
kpx <- function(edad, tabla_prob) {
  # Lista para guardar todos los kpx
  lista_kpx <- list()
  
  # Se obtienen iterativamente los kpx
  for (i in 1:(114 - edad)) {
    # Término p_{x + k + 1} ^ {ij}
    px_ij <-
      do.call(rbind, lapply(tabla_prob, function(df)
        df[(edad - 17 + i),]))
    
    # Se dividen por iteraciones
    if (i == 1) {
      # Término _{k - 1}p_{x}^{1i}
      px_anterior <-
        matrix(as.numeric(tabla_prob[[1]][(edad - 17),]),
               nrow = 6,
               ncol = 6)
      
      # Se obtienen los _{2}p_{x}^{1j}
      lista_kpx[[i]] <- colSums(px_ij * px_anterior)
      
    } else{
      # Se toman las probabilidades calculadas anteriormente
      px_anterior <-
        matrix(as.numeric(lista_kpx[[(i - 1)]]),
               nrow = 6,
               ncol = 6)
      
      # Se obtienen los _{2}p_{x}^{1j}
      lista_kpx[[i]] <- colSums(px_ij * px_anterior)
    }
  }
  
  # Se obtiene el DataFrame con los datos correspondientes
  df <- as.data.frame(t(data.frame(lista_kpx)))
  
  # Se agregan las transiciones de 1 paso
  df <- rbind(tabla_prob[[1]][(edad - 17), ], df)
  
  # Ajustamos las últimas probabilidades
  df[nrow(df), ] <- 0
  df[nrow(df), ncol(df)] <- 1

  # Se modifican los nombres de las filas
  rownames(df) <- 1:(115 - edad)
  return(df)
}
```

Se realiza un ejemplo de la función anterior.

```{r prueba_kpx}
prueba_kpx <- kpx(18, prob_mujeres)
```

# Cálculo de las primas

Primeramente se crea una función que devuelva el valor de un seguro completo para una vida de edad x.
Para esto, se considera la siguiente fórmula:

$$A_x^{05} = v \cdot p_x^{05} + \sum_{k=1}^{114-x} \left[ v^{k+1} \cdot \sum_{z=0}^{4} _kp_x^{0z} \cdot p_{x+k}^{z5} \right]$$

```{r seguro_completo}
# Función para calcular el seguro de vida completo del producto
# x: edad de la persona
# v: vector con los facotres de descuento
# matriz_kpx: matriz con los kpx^{0j}
# tabla_prob: prob_hombres o prob_mujeres
Ax05 <- function(x, v, matriz_kpx, tabla_prob) {
  seguro_completo <- v[1] * matriz_kpx[1, 6]
  
  for (k in 1:(114 - x)) {
    kpx0z <- matriz_kpx[k, 1:5]
    
    pxk_z5 <- c(tabla_prob[[1]][x + k - 17, 6],
                tabla_prob[[2]][x + k - 17, 6],
                tabla_prob[[3]][x + k - 17, 6],
                tabla_prob[[4]][x + k - 17, 6],
                tabla_prob[[5]][x + k - 17, 6])
    
    seguro_completo <- seguro_completo + v[k + 1] * sum(kpx0z * pxk_z5)
  }
  
  return(seguro_completo)
}
```

Con esto, se procede a determinar las primas anuales por edad para cada sexo.

```{r primas}
# Tasa equivalente que se usará en los cálculos
j = 0.0097

# Montos de los beneficios
S = 3100000
c1 = 1430000
c2 = 2119000
c3 = 10089000
c4 = 14418000

# Vectores con las primas
primas_h <- c()
primas_m <- c()

# Iteramos sobre cada edad para determinar las primas
for (x in 18:64) {
  # Vector con los factores de descuento
  v_j = (1 + j) ^ (-(1:(115 - x)))
  
  # Generamos la matriz con los kpx para ambos sexos
  kpx_h <- kpx(x, prob_hombres)
  kpx_m <- kpx(x, prob_mujeres)
  
  # Se determina la prima para un hombre de edad x
  
  # Seguro de vida completo
  Ax_05 <- Ax05(x, v_j, kpx_h, prob_hombres)
  
  # Anualidad de las primas
  ax00 <- 1 + ifelse(x < 64, (sum(v_j[1:(64 - x)] * kpx_h[1:(64 - x), 1])), 0)
  
  # Anualidad para el estado leve
  ax01 <- sum(v_j * kpx_h[, 2])
  
  # Anualidad para el estado moderado
  ax02 <- sum(v_j * kpx_h[, 3])
  
  # Anualidad para el estado severo
  ax03 <- sum(v_j * kpx_h[, 4])
  
  # Anualidad para el estado profundo
  ax04 <- sum(v_j * kpx_h[, 5])
  
  # Calculamos la prima con todo lo anterior
  prima <- (S * Ax_05 + c1 * ax01 + c2 * ax02 + c3 * ax03 + c4 * ax04) / (0.9 *
                                                                           ax00 - 0.1)
  # Guardamos la prima para alguien de edad x en el vector de primas
  primas_h <- c(primas_h, prima)
  
  # Analogamente se determina la prima para una mujer de edad x
  
  # Seguro de vida completo
  Ax_05 <- Ax05(x, v_j, kpx_m, prob_mujeres)
  
  # Anualidad de las primas
  ax00 <- 1 + ifelse(x < 64, (sum(v_j[1:(64 - x)] * kpx_m[1:(64 - x), 1])), 0)
  
  # Anualidad para el estado leve
  ax01 <- sum(v_j * kpx_m[, 2])
  
  # Anualidad para el estado moderado
  ax02 <- sum(v_j * kpx_m[, 3])
  
  # Anualidad para el estado severo
  ax03 <- sum(v_j * kpx_m[, 4])
  
  # Anualidad para el estado profundo
  ax04 <- sum(v_j * kpx_m[, 5])
  
  # Calculamos la prima con todo lo anterior
  prima <- (S * Ax_05 + c1 * ax01 + c2 * ax02 + c3 * ax03 + c4 * ax04) / (0.9 *
                                                                           ax00 - 0.1)
  # Guardamos la prima para alguien de edad x en el vector de primas
  primas_m <- c(primas_m, prima)
}
```

# Rentabilidad del producto

## Cartera de seguros

Se realizó un documento de *MS Excel* con una variedad de personas, estas representan los distintos sexos y edades que se encuentran en la cartera de seguros de la hipotética aseguradora. La justificación de las cantidades de personas, distribuciones de sexo y demás, se encuentra detallado en el documento escrito, como referencia, se realizan algunos graficos descriptivos para la visualización de los datos.

```{r datos_cartera, message = FALSE}
# Se descarga la cartera
cartera_seguros <- read_excel("data/Cartera de seguros.xlsx")

# Sexo de la cartera
cartera_seguros %>% 
  ggplot(aes(x = Sexo)) +
  geom_bar(fill = "darkorchid") +
  #facet_wrap(~Sexo) +
  labs(
    x = "Sexo",
    y = "Frecuencia",
    title = "Frecuencia de sexos",
    
  ) +
  cowplot::theme_cowplot()

# Histograma de edades por sexo
cartera_seguros %>% 
  ggplot(aes(x = Edades, fill = Sexo)) +
  geom_histogram(color = "white", binwidth = 1) +
  facet_wrap(~Sexo) +
  labs(
    x = "Edad",
    y = "Frecuencia",
    title = "Frecuencia de edades por sexo",
    
  ) +
  cowplot::theme_cowplot()
```

## Modelos estocásticos

En esta sección se implementará el primer modelo estocástico, el cual simula la cantidad de personas en los diferentes estados al final de cada año, desde el 2024. Para esto, se desarrollará una función que devuelve una lista, esta contiene una lista con la proyección de personas y otra con la proyección de gastos.

Inicialmente, los gastos por edad son fijos según el estado, entonces determinaremos estos.

```{r flujos_deterministicos}
# Ingresos determinísticos de hombres
ingresos_h <- data.frame(
  "0" = c(primas_h, rep(0, 51)),
  "1" = rep(0, 98),
  "2" = rep(0, 98),
  "3" = rep(0, 98),
  "4" = rep(0, 98),
  row.names = 18:115
)

# Ingresos determinísticos de mujeres
ingresos_m <- data.frame(
  "0" = c(primas_m, rep(0, 51)),
  "1" = rep(0, 98),
  "2" = rep(0, 98),
  "3" = rep(0, 98),
  "4" = rep(0, 98),
  row.names = 18:115
)
```

Seguidamente se va a generar un vector para cada sexo donde cada uno incluya la cantidad de personas por edad, usando lo realizado en la sección de la cartera de seguros.

```{r personas_edad}
poblacion_cartera <- as.data.frame(cartera_seguros)

poblacion_cartera$Edades <- as.numeric(poblacion_cartera$Edades)

hombres_cartera <- table(poblacion_cartera$Edades[poblacion_cartera$Sexo == "M"])
mujeres_cartera <- table(poblacion_cartera$Edades[poblacion_cartera$Sexo == "F"])

# Se ordenan los vectores por edad
edades <- sort(unique(poblacion_cartera$Edades))

hombres_cartera <- as.numeric(hombres_cartera[as.character(edades)])
mujeres_cartera <- as.numeric(mujeres_cartera[as.character(edades)])
```

Con los datos ya construidos, obtenemos la función para el modelo estocástico.

```{r modelo_estocastico}
# Función que ejecuta el primer modelo estocástico requerido
# simulaciones: cantidad de simulaciones del modelo estocástico
# tabla_prob: prob_hombres o prob_mujeres
# num_personas: hombres_cartera o mujeres_cartera
# ingresos: 
modelo_estoc <- function(simulaciones,
                         tabla_prob,
                         num_personas,
                         ingresos) {
  # Listas con las matrices de cada simulación
  lista_personas <- list()
  lista_gastos <- list()
  lista_ingresos <- list()
  lista_auxi <- list()
  lista_auxg <- list()
  
  # Matriz de personas
  matriz_personas <- matrix(0, nrow = 97, ncol = 98)
  
  # Primer columna
  matriz_personas[, 1] <- c(num_personas, rep(0, 50))
  
  # Valores presentes
  vp <- (1 / (1 + j)) ^ (0:97)
  
  # LLenamos la matriz
  for (i in 2:47) {
    matriz_personas[, i] <-
      c(rep(0, (i - 1)), num_personas, rep(0, 51 - i))
  }
  
  # Iteramos la cantidad de simulaciones especificada
  for (simulacion in 1:simulaciones) {
    
    # Matriz para el escenario de la simulación
    escenario <- matrix(NA, nrow = 97, ncol = 98)
    
    # Vector con las edades
    edades <- 1:47
    
    # Las personas de edad 18 a 64 empiezan en el estado 0
    escenario[edades, 1] <- 0
    
    # Generamos una matriz aleatoria para cada edad
    matrices_aleatorias <- lapply(edades, function(x)
      matrix(runif(98 * 6), nrow = 98, ncol = 6))
    
    # Lista con los intervalos de transición iniciales
    intervalos_list <- lapply(edades, function(x) {
      unname(cumsum(c(0, tabla_prob[[1]][edades[x],])))
    })
    
    # Iteramos sobre cada edad
    for (i in edades) {
      # Guardamos la matriz aleatoria y los intervalos correspondientes
      matriz_aleatoria <- matrices_aleatorias[[i]]
      intervalos <- intervalos_list[[i]]
      
      # Determinamos el nuevo estado para el segundo año (2025)
      estado <-
        which(intervalos[-length(intervalos)] < matriz_aleatoria[i, 1] &
                matriz_aleatoria[i, 1] <= intervalos[-1]) - 1
      
      # Iteramos sobre los años
      for (k in 1:(97 - i)) {
        # Guardamos el estado de la persona para el año corrrespondiente
        escenario[i + k, 1 + k] <- estado
        
        # Si el estado es 5 la persona sale del modelo, sino, se determina el nuevo
        # estado al que transiciona
        if (estado < 5) {
          # Vector con los intervalos de transición
          intervalos <-
            unname(cumsum(c(tabla_prob[[estado + 1]][i + k,])))
          
          # Si el estado es 0 o 1, hay que agregarle un 0 a los intervalos
          if (estado < 2) {
            intervalos <- c(0, intervalos)
          }
          
          # Se determina el "nuevo estado"
          estado_nuevo <-
            which(intervalos[-length(intervalos)] < matriz_aleatoria[i + k, estado + 1] &
                    matriz_aleatoria[i + k, estado + 1] <= intervalos[-1]) - 1
          
          # Actualizamos el estado dependiendo del valor del "nuevo estado"
          estado <-
            ifelse(estado_nuevo < estado, estado - 1, estado_nuevo)
        } else{
          # Para no ir acumulando los fallecidos, establecemos el estado en 6 si la
          # persona falleció el año anterior
          estado <- 6
          
        } # fin if-else
      } # fin for k
    } # fin for i
    
    # Matriz con la cantidad de personas por año para cada estado
    personas_estados <- matrix(0, nrow = 6, ncol = 98)
    
    # Llenamos la matriz
    for (i in 0:5) {
      personas_estados[(i + 1),] <- apply(escenario, 2, function(col) {
        col <- col[!is.na(col)]
        sum(num_personas[1:length(col)][col == i])
      })
      
    }
    
    # Guardamos la matriz en la lista como un DataFrame
    lista_personas[[simulacion]] <-
      data.frame(personas_estados, row.names = 0:5)
    
    # Para el otro modelo estocástico, iniciamos obteniendo los gastos según el escenario
    gastos_estoc <-
      ifelse(escenario == 0, 0, ifelse(
        escenario == 1,
        1430000,
        ifelse(
          escenario == 2,
          2119000,
          ifelse(
            escenario == 3,
            10089000,
            ifelse(escenario == 4, 14418000, ifelse(escenario == 5, 3100000, 0))
          )
        )
      ))
    
    # Ingresos según escenario
    ingresos_estoc <- ifelse(escenario == 0, ingresos[, 1], 0)
    
    # No se pagan primas después de los 64
    ingresos_estoc[48:nrow(ingresos_estoc), ] <- 0
    
    # Personas por escenario
    gastos_estoc <- gastos_estoc * matriz_personas
    ingresos_estoc <- ingresos_estoc * matriz_personas
    
    lista_gastos[[simulacion]] <- gastos_estoc
    lista_ingresos[[simulacion]] <- escenario
    
    
    # Iteramos por cada estado para obtener los ingresos/gastos por estado
    for (i in 0:5) {
      # Obtenemos las coincidencias de estados
      coincidencias <- escenario == i

      # Dejamos los valores que coinciden con el estado
      gastos_estado <- gastos_estoc * coincidencias
      ingresos_estado <- ingresos_estoc * coincidencias

      # Sumamos los gastos/ingresos, por separado, en cada uno de los años
      gastos_sum <- colSums(gastos_estado, na.rm = TRUE)
      ingresos_sum <- colSums(ingresos_estado, na.rm = TRUE)

      # Se obtiene el valor presente cada año, para luego sumarse
      lista_auxg[[(i + 1)]] <- sum(gastos_sum * vp)
      lista_auxi[[(i + 1)]] <- sum(ingresos_sum * vp)
    }

    lista_gastos[[simulacion]] <- unname(unlist(lista_auxg))
    lista_ingresos[[simulacion]] <- unname(unlist(lista_auxi)
    )
    
  } # fin for simulaciones
  
  return(list(lista_personas, lista_gastos, lista_ingresos))
  
}
```

Ahora se procederá a determinar la esperanza de las matrices asociadas a las 10 000 simulaciones.

```{r esperanza}
# Definimos la semilla para reproducibilidad
set.seed(2024)

# Cantidad de simulaciones
n_sim <- 10000

# Determinamos las matrices asociadas a las simulaciones determinadas, tanto para hombres y mujeres
simulaciones_h <- modelo_estoc(n_sim, prob_hombres, hombres_cartera, ingresos_h)
simulaciones_m <- modelo_estoc(n_sim, prob_mujeres, mujeres_cartera, ingresos_m)

# Matrices con las esperanzas por estado y para cada año, para cada sexo
esperanzas_h <- Reduce("+", simulaciones_h[[1]]) / n_sim
esperanzas_m <- Reduce("+", simulaciones_m[[1]]) / n_sim
```
