---
title: "proyecto_contingencias_ii"
output: html_document
---

# Preparación inicial

Inicialmente, se importan las librerías requeridas para el proyecto.

```{r librerias}
pacman::p_load(dplyr,
               ggplot2,
               readxl)
```

## Fuerzas de mortalidad

Se obtienen las tablas con los parámetros de las fuerzas de mortalidad para cada edad.

```{r tablas_mux}
# Se importa la tabla masculina de intensidades graduales a estados de restricción de actividad central
hombres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_estados_restr")

# Se importa la tabla femenina de intensidades graduales a estados de restricción de actividad central
mujeres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_estados_restr")

# Se importa la tabla masculina transiciones graduales de recuperación
hombres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_recuperación")

# Se importa la tabla femenina transiciones graduales de recuperación
mujeres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_recuperación")

# Se importa la tabla masculina intensidades de transición graduales de mortalidad
hombres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "h_mortalidad")

# Se importa la tabla femenina intensidades de transición graduales de mortalidad
mujeres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "m_mortalidad")
```

Se procede con las funciones para obtener las fuerzas de mortalidad, inicialmente, con las fuerzas que transicionan de los estados en donde el individuo se encuentra con vida hacia adelante ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i < j$).

```{r mu_transicion}
# Función para obtener las intensidades de transición graduales a estados de restricción de actividad central
# x: edad
# tabla: hombres_restr o mujeres_restr
# mu: mu_12, mu_13, mu_14, mu_15, mu_23, mu_24, mu_25, mu_34, mu_35 o mu_45
restr_act_central <- function(x, tabla, mu) {
  # Se separan los casos para edades menores a 65
  if (x <= 65) {
    valor_mu <-
      (tabla[[mu]][1] + tabla[[mu]][2] * (tabla[[mu]][3]) ^ x) / (1 + tabla[[mu]][4] * (tabla[[mu]][3]) ^
                                                                    x + tabla[[mu]][5] * (tabla[[mu]][3]) ^ (-x)) + tabla[[mu]][6]
  } else {
    valor_mu <-
      tabla[[mu]][8] * (x - 65) ^ 5 + tabla[[mu]][9] * (x - 65) ^ 4 + tabla[[mu]][10] * (x - 65) ^
      3 + tabla[[mu]][11] * (x - 65) ^ 2 + tabla[[mu]][12] * (x - 65) + tabla[[mu]][13]
    
  }
  
  return(valor_mu)
  
}

(prueba_1h <- restr_act_central(20, hombres_restr, "mu_12"))
(prueba_1m <- restr_act_central(21, mujeres_restr, "mu_12"))
```

Seguidamente, la función para obtener las fuerzas de recuperación ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i > j$).

```{r mu_recuperacion}
# Función para calcular las intensidades de transición graduales a recuperación
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_21, mu_32, mu_43 o mu_54
recuperacion <- function(x, tabla, mu) {
  valor_mu <-
    (tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x)) / (1 + tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x))
  
  return(valor_mu)
}

(prueba_2h <- recuperacion(20, hombres_recup, "mu_21"))
(prueba_2m <- recuperacion(21, mujeres_recup, "mu_21"))
```

Luego, la función para obtener las fuerzas de transición hacia la muerte ($\mu_{x}^{i6} \hspace{0.5cm} \forall i \in \{1, 2, \dots, 5\}$).

```{r mu_muerte}
# Función para calcular las intensidades de transición graduales a mortalidad
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_16, mu_26, mu_36, mu_46 o mu_56
mortalidad <- function(x, tabla, mu) {
  valor_mu <-
    tabla[[mu]][1] + tabla[[mu]][2] * x + exp(tabla[[mu]][3] + tabla[[mu]][4] * x)
  
  return(valor_mu)
  
}

(prueba_3h <- mortalidad(20, hombres_mort, "mu_16"))
(prueba_3m <- mortalidad(21, mujeres_mort, "mu_16"))
```

## Probabilidades de transición

Se obtienen las tablas con las probabilidades de transición expuestas en el paper.

```{r prob_transicion, warning = FALSE, message = FALSE}
# Importar tablas con probabilidades de transición
hombres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "h_prob_transicion")
mujeres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "m_prob_transicion")
```

Se modifican los nombres de las columnas correspondientes.

```{r nombres_transicion}
colnames(hombres_prob_transicion)[1:2] <- c("Edad", "Capaz")
colnames(mujeres_prob_transicion)[1:2] <- c("Edad", "Capaz")
```

Se obtienen, por separado, las probabilidades de transición de cada estado. Esto quiere decir que el índice de la lista coincide con el estado correspondiente, por ejemplo, prob_hombres[[2]] coincide con el estado leve (2).

Junto a lo anterior, en el paper se menciona que no todas las filas suman 1, por lo cual, se hará una corrección uniforme a cada edad para que los modelos tengan sentido.

```{r corrección_probabilidades}
# Se crea una lista para las probabilidades de cada sexo
prob_hombres <- list()
prob_mujeres <- list()

# Se itera para separar las probabilidades por estados
for (i in c(1:6)) {
  prob_hombres[[i]] <-
    as.data.frame(hombres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  prob_mujeres[[i]] <-
    as.data.frame(mujeres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  
  # Se pone la edad en el nombre de fila de cada DataFrame
  rownames(prob_hombres[[i]]) <- seq(20, 80, 10)
  rownames(prob_mujeres[[i]]) <- seq(20, 80, 10)
  
  # Se elimina la columna de edad
  prob_hombres[[i]] <- prob_hombres[[i]] %>%
    select(-Edad)
  prob_mujeres[[i]] <- prob_mujeres[[i]] %>%
    select(-Edad)
}

# Obtenemos la suma de las filas en cada matriz
suma_hombres <- sapply(prob_hombres, rowSums)
suma_mujeres <- sapply(prob_mujeres, rowSums)

# Corregimos las filas que no suman 1
for (i in 1:length(prob_hombres)) {
  # Se separan los casos especiales
  if (i != 3 && i != 4) {
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 6)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 6)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- prob_hombres[[i]] + correccion_hombres
    prob_mujeres[[i]] <- prob_mujeres[[i]] + correccion_mujeres
  } else if(i == 3){
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 5)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 5)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1], prob_hombres[[i]][2:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1], prob_mujeres[[i]][2:6] + correccion_mujeres)
  } else{
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 4)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 4)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1:2], prob_hombres[[i]][3:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1:2], prob_mujeres[[i]][3:6] + correccion_mujeres)
  }
}

# Se eliminan las variables innecesarias
rm(correccion_hombres, correccion_mujeres, suma_mujeres, suma_hombres)
```

Con las probabilidades corregidas, se continúa obteniendo las probabilidades de transición intermedias, para edades de 18 a 115, usando el supuesto de fuerza de mortalidad constante.

```{r probabilidades_intermedias}
# Recorremos cada estado
for (i in 1:6) {
  # Iniciamos encontrando las pendientes
  pendientesh <-
    (prob_hombres[[i]][2:7, ] - prob_hombres[[i]][1:6, ]) / 10
  pendientesm <-
    (prob_mujeres[[i]][2:7, ] - prob_mujeres[[i]][1:6, ]) / 10
  
  # Listas para guardar las columnas
  lista_colsh <- list()
  lista_colsm <- list()
  lista_auxh <- list()
  lista_auxm <- list()
  
  # Construimos cada columna
  for (j in 1:6) {
    # Probabilidades de los hombres
    lista_colsh[[1]] <- prob_hombres[[i]][1, j] + pendientesh[1, j] * -2:9
    lista_colsh[[2]] <-
      prob_hombres[[i]][2, j] + pendientesh[2, j] * 0:9
    lista_colsh[[3]] <-
      prob_hombres[[i]][3, j] + pendientesh[3, j] * 0:9
    lista_colsh[[4]] <-
      prob_hombres[[i]][4, j] + pendientesh[4, j] * 0:9
    lista_colsh[[5]] <-
      prob_hombres[[i]][5, j] + pendientesh[5, j] * 0:9
    lista_colsh[[6]] <-
      prob_hombres[[i]][6, j] + pendientesh[6, j] * 0:45
    
    # Probabilidades de las mujeres
    lista_colsm[[1]] <- prob_mujeres[[i]][1, j] + pendientesm[1, j] * -2:9
    lista_colsm[[2]] <-
      prob_mujeres[[i]][2, j] + pendientesm[2, j] * 0:9
    lista_colsm[[3]] <-
      prob_mujeres[[i]][3, j] + pendientesm[3, j] * 0:9
    lista_colsm[[4]] <-
      prob_mujeres[[i]][4, j] + pendientesm[4, j] * 0:9
    lista_colsm[[5]] <-
      prob_mujeres[[i]][5, j] + pendientesm[5, j] * 0:9
    lista_colsm[[6]] <-
      prob_mujeres[[i]][6, j] + pendientesm[6, j] * 0:45
    
    # Obtenemos el dataframe
    lista_auxh[[j]] <- unlist(lista_colsh)
    lista_auxm[[j]] <- unlist(lista_colsm)
  }
  
  # Se extraen los dataframes en las probabilidades
  prob_hombres[[i]] <- data.frame(lista_auxh, row.names = 18:115)
  prob_mujeres[[i]] <- data.frame(lista_auxm, row.names = 18:115)
  colnames(prob_hombres[[i]]) <- c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
  colnames(prob_mujeres[[i]]) <- c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
}
```

