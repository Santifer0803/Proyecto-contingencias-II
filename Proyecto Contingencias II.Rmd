---
title: "proyecto_contingencias_ii"
output: html_document
---

# Preparación inicial

Inicialmente, se importan las librerías requeridas para el proyecto.

```{r librerias}
pacman::p_load(dplyr,
               ggplot2,
               readxl)
```

## Fuerzas de mortalidad

Se obtienen las tablas con los parámetros de las fuerzas de mortalidad para cada edad.

```{r tablas_mux}
# Se importa la tabla masculina de intensidades graduales a estados de restricción de actividad central
hombres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_estados_restr")

# Se importa la tabla femenina de intensidades graduales a estados de restricción de actividad central
mujeres_restr <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_estados_restr")

# Se importa la tabla masculina transiciones graduales de recuperación
hombres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "h_recuperación")

# Se importa la tabla femenina transiciones graduales de recuperación
mujeres_recup <- read_excel("data/Tablas Proyecto Final.xlsx",
                            sheet = "m_recuperación")

# Se importa la tabla masculina intensidades de transición graduales de mortalidad
hombres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "h_mortalidad")

# Se importa la tabla femenina intensidades de transición graduales de mortalidad
mujeres_mort <- read_excel("data/Tablas Proyecto Final.xlsx",
                           sheet = "m_mortalidad")
```

Se procede con las funciones para obtener las fuerzas de mortalidad, inicialmente, con las fuerzas que transicionan de los estados en donde el individuo se encuentra con vida hacia adelante ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i < j$).

```{r mu_transicion}
# Función para obtener las intensidades de transición graduales a estados de restricción de actividad central
# x: edad
# tabla: hombres_restr o mujeres_restr
# mu: mu_12, mu_13, mu_14, mu_15, mu_23, mu_24, mu_25, mu_34, mu_35 o mu_45
restr_act_central <- function(x, tabla, mu) {
  # Se separan los casos para edades menores a 65
  if (x <= 65) {
    valor_mu <-
      (tabla[[mu]][1] + tabla[[mu]][2] * (tabla[[mu]][3]) ^ x) / (1 + tabla[[mu]][4] * (tabla[[mu]][3]) ^
                                                                    x + tabla[[mu]][5] * (tabla[[mu]][3]) ^ (-x)) + tabla[[mu]][6]
  } else {
    valor_mu <-
      tabla[[mu]][8] * (x - 65) ^ 5 + tabla[[mu]][9] * (x - 65) ^ 4 + tabla[[mu]][10] * (x - 65) ^
      3 + tabla[[mu]][11] * (x - 65) ^ 2 + tabla[[mu]][12] * (x - 65) + tabla[[mu]][13]
    
  }
  
  return(valor_mu)
  
}

(prueba_1h <- restr_act_central(20, hombres_restr, "mu_12"))
(prueba_1m <- restr_act_central(21, mujeres_restr, "mu_12"))
```

Seguidamente, la función para obtener las fuerzas de recuperación ($\mu_{x}^{ij} \hspace{0.5cm} \forall i, j \in \{1, 2, \dots, 5\} \hspace{0.1cm} \wedge \hspace{0.1cm} i > j$).

```{r mu_recuperacion}
# Función para calcular las intensidades de transición graduales a recuperación
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_21, mu_32, mu_43 o mu_54
recuperacion <- function(x, tabla, mu) {
  valor_mu <-
    (tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x)) / (1 + tabla[[mu]][1] + exp(tabla[[mu]][2] + tabla[[mu]][3] * x))
  
  return(valor_mu)
}

(prueba_2h <- recuperacion(20, hombres_recup, "mu_21"))
(prueba_2m <- recuperacion(21, mujeres_recup, "mu_21"))
```

Luego, la función para obtener las fuerzas de transición hacia la muerte ($\mu_{x}^{i6} \hspace{0.5cm} \forall i \in \{1, 2, \dots, 5\}$).

```{r mu_muerte}
# Función para calcular las intensidades de transición graduales a mortalidad
# x: edad
# tabla: hombres_recup o mujeres_recup
# mu: mu_16, mu_26, mu_36, mu_46 o mu_56
mortalidad <- function(x, tabla, mu) {
  valor_mu <-
    tabla[[mu]][1] + tabla[[mu]][2] * x + exp(tabla[[mu]][3] + tabla[[mu]][4] * x)
  
  return(valor_mu)
  
}

(prueba_3h <- mortalidad(20, hombres_mort, "mu_16"))
(prueba_3m <- mortalidad(21, mujeres_mort, "mu_16"))
```

## Probabilidades de transición

Se obtienen las tablas con las probabilidades de transición expuestas en el paper.

```{r prob_transicion, warning = FALSE, message = FALSE}
# Importar tablas con probabilidades de transición
hombres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "h_prob_transicion")
mujeres_prob_transicion <-
  read_excel("data/Tablas Proyecto Final.xlsx",
             sheet = "m_prob_transicion")
```

Se modifican los nombres de las columnas correspondientes.

```{r nombres_transicion}
colnames(hombres_prob_transicion)[1:2] <- c("Edad", "Capaz")
colnames(mujeres_prob_transicion)[1:2] <- c("Edad", "Capaz")
```

Se obtienen, por separado, las probabilidades de transición de cada estado. Esto quiere decir que el índice de la lista coincide con el estado correspondiente, por ejemplo, prob_hombres[[2]] coincide con el estado leve (2).

Junto a lo anterior, en el paper se menciona que no todas las filas suman 1, por lo cual, se hará una corrección uniforme a cada edad para que los modelos tengan sentido.

```{r corrección_probabilidades}
# Se crea una lista para las probabilidades de cada sexo
prob_hombres <- list()
prob_mujeres <- list()

# Se itera para separar las probabilidades por estados
for (i in c(1:6)) {
  prob_hombres[[i]] <-
    as.data.frame(hombres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  prob_mujeres[[i]] <-
    as.data.frame(mujeres_prob_transicion[(8 * i - 7):(8 * i - 1),])
  
  # Se pone la edad en el nombre de fila de cada DataFrame
  rownames(prob_hombres[[i]]) <- seq(20, 80, 10)
  rownames(prob_mujeres[[i]]) <- seq(20, 80, 10)
  
  # Se elimina la columna de edad
  prob_hombres[[i]] <- prob_hombres[[i]] %>%
    select(-Edad)
  prob_mujeres[[i]] <- prob_mujeres[[i]] %>%
    select(-Edad)
}

# Obtenemos la suma de las filas en cada matriz
suma_hombres <- sapply(prob_hombres, rowSums)
suma_mujeres <- sapply(prob_mujeres, rowSums)

# Corregimos las filas que no suman 1
for (i in 1:length(prob_hombres)) {
  # Se separan los casos especiales
  if (i != 3 && i != 4) {
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 6)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 6)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- prob_hombres[[i]] + correccion_hombres
    prob_mujeres[[i]] <- prob_mujeres[[i]] + correccion_mujeres
  } else if(i == 3){
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 5)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 5)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1], prob_hombres[[i]][2:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1], prob_mujeres[[i]][2:6] + correccion_mujeres)
  } else{
    # Corrección uniforme por edad
    correccion_hombres <- ((1 - suma_hombres[, i]) / 4)
    correccion_mujeres <- ((1 - suma_mujeres[, i]) / 4)
    
    # Se aplica la corrección
    prob_hombres[[i]] <- cbind(prob_hombres[[i]][1:2], prob_hombres[[i]][3:6] + correccion_hombres)
    prob_mujeres[[i]] <- cbind(prob_mujeres[[i]][1:2], prob_mujeres[[i]][3:6] + correccion_mujeres)
  }
}

# Se eliminan las variables innecesarias
rm(correccion_hombres, correccion_mujeres, suma_mujeres, suma_hombres)
```

Con las probabilidades corregidas, se continúa obteniendo las probabilidades de transición intermedias, para edades de 18 a 115, usando el supuesto de fuerza de mortalidad constante.

```{r probabilidades_intermedias}
# Recorremos cada estado
for (i in 1:6) {
  # Iniciamos encontrando las pendientes
  pendientesh <-
    (prob_hombres[[i]][2:7,] - prob_hombres[[i]][1:6,]) / 10
  pendientesm <-
    (prob_mujeres[[i]][2:7,] - prob_mujeres[[i]][1:6,]) / 10
  
  # Listas para guardar las columnas
  lista_colsh <- list()
  lista_colsm <- list()
  lista_auxh <- list()
  lista_auxm <- list()
  
  # Construimos cada columna
  for (j in 1:6) {
    # Probabilidades de los hombres
    lista_colsh[[1]] <-
      prob_hombres[[i]][1, j] + pendientesh[1, j] * -2:9
    lista_colsh[[2]] <-
      prob_hombres[[i]][2, j] + pendientesh[2, j] * 0:9
    lista_colsh[[3]] <-
      prob_hombres[[i]][3, j] + pendientesh[3, j] * 0:9
    lista_colsh[[4]] <-
      prob_hombres[[i]][4, j] + pendientesh[4, j] * 0:9
    lista_colsh[[5]] <-
      prob_hombres[[i]][5, j] + pendientesh[5, j] * 0:9
    lista_colsh[[6]] <-
      prob_hombres[[i]][6, j] + pendientesh[6, j] * 0:45
    
    # Probabilidades de las mujeres
    lista_colsm[[1]] <-
      prob_mujeres[[i]][1, j] + pendientesm[1, j] * -2:9
    lista_colsm[[2]] <-
      prob_mujeres[[i]][2, j] + pendientesm[2, j] * 0:9
    lista_colsm[[3]] <-
      prob_mujeres[[i]][3, j] + pendientesm[3, j] * 0:9
    lista_colsm[[4]] <-
      prob_mujeres[[i]][4, j] + pendientesm[4, j] * 0:9
    lista_colsm[[5]] <-
      prob_mujeres[[i]][5, j] + pendientesm[5, j] * 0:9
    lista_colsm[[6]] <-
      prob_mujeres[[i]][6, j] + pendientesm[6, j] * 0:45
    
    # Obtenemos el dataframe
    lista_auxh[[j]] <- unlist(lista_colsh)
    lista_auxm[[j]] <- unlist(lista_colsm)
  }
  
  # Se extraen los dataframes en las probabilidades
  prob_hombres[[i]] <- data.frame(lista_auxh, row.names = 18:115)
  prob_mujeres[[i]] <- data.frame(lista_auxm, row.names = 18:115)
  colnames(prob_hombres[[i]]) <-
    c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
  colnames(prob_mujeres[[i]]) <-
    c("Capaz", "Leve", "Moderado", "Severo", "Profundo", "Muerto")
}

# Se eliminan las variables innecesarias
rm(pendientesh,
   pendientesm,
   lista_auxh,
   lista_auxm,
   lista_colsh,
   lista_colsm)
```

Posteriormente, se procede a obtener las probabilidades de transición de varios pasos, esto para el cálculo de las primas. La fórmula correspondiente viene dada por:

$$_{k}p_{x} ^ {1j} = \sum_{i = 1} ^ {6} {}_{k - 1}p_{x} ^ {1i} \cdot p_{x + k + 1} ^ {ij}, \hspace{0.3cm} k \geq 2 \hspace{0.1cm} \wedge \hspace{0.1cm} j \in \{1, 2, \dots, 6\}$$

```{r probabilidades_mayores}
# Función para calcular los kpx^{1j}
# edad: edad del individuo (x)
# tabla_prob: prob_hombres o prob_mujeres
kpx <- function(edad, tabla_prob) {
  # Lista para guardar todos los kpx
  lista_kpx <- list()
  
  # Se obtienen iterativamente los kpx
  for (i in 1:(115 - edad)) {
    # Término p_{x + k + 1} ^ {ij}
    px_ij <-
      do.call(rbind, lapply(tabla_prob, function(df)
        df[(edad - 17 + i),]))
    
    # Se dividen por iteraciones
    if (i == 1) {
      # Término _{k - 1}p_{x}^{1i}
      px_anterior <-
        matrix(as.numeric(tabla_prob[[1]][(edad - 17),]),
               nrow = 6,
               ncol = 6)
      
      # Se obtienen los _{2}p_{x}^{1j}
      lista_kpx[[i]] <- colSums(px_ij * px_anterior)
      
    } else{
      # Se toman las probabilidades calculadas anteriormente
      px_anterior <-
        matrix(as.numeric(lista_kpx[[(i - 1)]]),
               nrow = 6,
               ncol = 6)
      
      # Se obtienen los _{2}p_{x}^{1j}
      lista_kpx[[i]] <- colSums(px_ij * px_anterior)
    }
  }
  
  # Se obtiene el DataFrame con los datos correspondientes
  df <- as.data.frame(t(data.frame(lista_kpx)))
  
  # Se agregan las transiciones de 1 paso
  df <- rbind(tabla_prob[[1]][(edad - 17), ], df)
  
  # Ajustamos las últimas probabilidades
  df[nrow(df), ] <- 0
  df[nrow(df), ncol(df)] <- 1

  # Se modifican los nombres de las filas
  rownames(df) <- 1:(115 - edad + 1)
  return(df)
}
```

Se realiza un ejemplo de la utilización de la función anterior.

```{r prueba_kpx}
prueba_kpx <- kpx(18, prob_mujeres)
```

# Cálculo de las primas

Primeramente se crea una función que devuelva el valor de un seguro temporal a n años

```{r seguro_temporal}
# Función para calcular el seguro de vida temporal del producto
# x: edad de la persona
# v: vector con los facotres de descuento
# matriz_kpx: matriz con los kpx^{0j}
# tabla_prob: prob_hombres o prob_mujeres
Axn05 <- function(x, v, matriz_kpx, tabla_prob) {
  seguro_temporal <- v[1] * matriz_kpx[1, 6]
  
  if (x < 64) {
    for (k in 1:(64 - x)) {
      kpx0z <- matriz_kpx[k, 1:5]
      
      pxk_z5 <- c(tabla_prob[[1]][x + k - 17, 6],
                  tabla_prob[[2]][x + k - 17, 6],
                  tabla_prob[[3]][x + k - 17, 6],
                  tabla_prob[[4]][x + k - 17, 6],
                  tabla_prob[[5]][x + k - 17, 6])
      
      seguro_temporal <- seguro_temporal + v[k + 1] * sum(kpx0z * pxk_z5)
    }
    
  }
  
  return(seguro_temporal)
}
```

Con esto, se procede a determinar las primas anuales por edad para cada sexo.

```{r primas}
# Tasa equivalente que se usará en los cálculos
j = 0.0196

# Montos de los beneficios
S = 3100000
c1 = 1430000
c2 = 2119000
c3 = 10089000
c4 = 14418000

# Vectores con las primas
primas_h <- c()
primas_m <- c()

# Iteramos sobre cada edad para determinar las primas
for (x in 18:64) {
  # Vector con los factores de descuento
  v_j = (1 + j) ^ (-(1:(115 - x)))
  
  # Generamos la matriz con los kpx para ambos sexos
  kpx_h <- kpx(x, prob_hombres)[1:(115-x),]
  kpx_m <- kpx(x, prob_mujeres)[1:(115-x),]
  
  # Se determina la prima para un hombre de edad x
  
  # Seguro de vida temporal
  Ax05 <- Axn05(x, v_j, kpx_h, prob_hombres)
  
  # Anualidad de las primas
  ax00 <- 1 + sum(v_j[1:(64 - x)] * kpx_h[1:(64 - x), 1])
  
  # Anualidad para el estado leve
  ax01 <- sum(v_j * kpx_h[, 2])
  
  # Anualidad para el estado moderado
  ax02 <- sum(v_j * kpx_h[, 3])
  
  # Anualidad para el estado severo
  ax03 <- sum(v_j * kpx_h[, 4])
  
  # Anualidad para el estado profundo
  ax04 <- sum(v_j * kpx_h[, 5])
  
  # Calculamos la prima con todo lo anterior
  prima <- (S * Ax05 + c1 * ax01 + c2 * ax02 + c3 * ax03 + c4 * ax04) / (0.9 *
                                                                           ax00 - 0.1)
  # Guardamos la prima para alguien de edad x en el vector de primas
  primas_h <- c(primas_h, prima)
  
  # Analogamente se determina la prima para una mujer de edad x
  
  # Seguro de vida temporal
  Ax05 <- Axn05(x, v_j, kpx_m, prob_mujeres)
  
  # Anualidad de las primas
  ax00 <- 1 + sum(v_j[1:(64 - x)] * kpx_m[1:(64 - x), 1])
  
  # Anualidad para el estado leve
  ax01 <- sum(v_j * kpx_m[, 2])
  
  # Anualidad para el estado moderado
  ax02 <- sum(v_j * kpx_m[, 3])
  
  # Anualidad para el estado severo
  ax03 <- sum(v_j * kpx_m[, 4])
  
  # Anualidad para el estado profundo
  ax04 <- sum(v_j * kpx_m[, 5])
  
  # Calculamos la prima con todo lo anterior
  prima <- (S * Ax05 + c1 * ax01 + c2 * ax02 + c3 * ax03 + c4 * ax04) / (0.9 *
                                                                           ax00 - 0.1)
  # Guardamos la prima para alguien de edad x en el vector de primas
  primas_m <- c(primas_m, prima)
}
```

# Primer modelo estocástico

En esta sección se implementará el primer modelo estocástico, el cual simula la cantidad de personas en los diferentes estados al final de cada año, desde el 2024.
Para esto, se desarrollará una función que devuelve una lista con una matriz por simulación. Cada una de estas tendrá la cantidad de personas mencionada al final de cada año para cada estado.

```{r modelo_estocastico_1}
# Función que ejecuta el primer modelo estocástico requerido
# simulaciones: cantidad de simulaciones del modelo estocástico
# tabla_prob: prob_hombres o prob_mujeres
modelo_estoc <- function(simulaciones, tabla_prob) {
  lista_simulaciones <- list()
  
  for (simulacion in 1:simulaciones) {
    escenario <- matrix(NA, nrow = 97, ncol = 98)
    
    escenario[1:47, 1] <- rep(0, 47)
    
    for (i in 1:47) {
      matriz_aleatoria <- matrix(runif(115 * 6), nrow = 115, ncol = 6)
      
      estado <- 0
      
      intervalos <-
        unname(c(0, cumsum(c(tabla_prob[[estado + 1]][i,]))))
      
      for (j in 1:(length(intervalos) - 1)) {
        if (!(between(matriz_aleatoria[i, 1], intervalos[j], intervalos[j + 1]))) {
          estado <- estado + 1
          
        } else{
          break
          
        } # fin if-else
      } #fin for j
      
      for (k in 1:ncol(escenario)) {
        if (i + k < 98) {
          escenario[i + k, 1 + k] <- estado
          
          if (estado != 5) {
            intervalos <- unique(unname(c(0, cumsum(
              c(tabla_prob[[estado + 1]][i + k,])
            ))))
            
            estado_comp <- 0
            
            for (j in 1:(length(intervalos) - 1)) {
              if (!(between(matriz_aleatoria[i + k, estado + 1], intervalos[j], intervalos[j + 1]))) {
                estado_comp <- estado_comp + 1
                
              } else{
                break
                
              } # fin if-else
            } #fin for j
            
            if (estado_comp < estado) {
              estado <- estado - 1
              
            } else {
              estado <- estado_comp
              
            }
            
          } # fin segundo if
          
        } # fin primer if
        
      } # fin for k
      
    } # fin for i
    
    personas_estados <- matrix(0, nrow = 6, ncol = 98)
    
    for (i in 1:6) {
      personas_estados[i,] <- apply(escenario, 2, function(col)
        sum(col == (i - 1), na.rm = TRUE))
      
    }
    
    lista_simulaciones[[simulacion]] <- data.frame(personas_estados,
                                                   row.names = 0:5)
    
  } # fin for simulaciones
  
  return(lista_simulaciones)
  
}
```

Ahora se procederá a determinar la esperanza y el percentil 99.5 de las matrices asociadas a las x simulaciones.

```{r esperanza_percentil_99.5}
# Determinamos las matrices asociadas a las simulaciones determinadas, tanto para hombres y mujeres
simulaciones_h <- modelo_estoc(10, prob_hombres)
simulaciones_m <- modelo_estoc(10, prob_mujeres)

# Vectores para las esperanzas para cada año, por estado y para cada sexo
esperanzas_h <- matrix(0, nrow = 6, ncol = 98)
esperanzas_m <- matrix(0, nrow = 6, ncol = 98)

# Vectores para los percentiles 99.5 para cada año, por estado y para cada sexo
percentiles_h <- matrix(0, nrow = 6, ncol = 98)
percentiles_m <- matrix(0, nrow = 6, ncol = 98)

# Se itera sobre cada estado para obtener las esperanzas y percentiles para cada año
for (i in 1:6) {
  filas_estados <- do.call(rbind, lapply(simulaciones_h, function(matriz)
    matriz[i, ]))
  
  esperanzas_h[i, ] <- colMeans(filas_estados)
  
  percentiles_h[i, ] <- apply(filas_estados, 2, function(columna)
    quantile(columna, 0.995))
  
  filas_estados <- do.call(rbind, lapply(simulaciones_m, function(matriz)
    matriz[i, ]))
  
  esperanzas_m[i, ] <- colMeans(filas_estados)
  
  percentiles_m <- apply(filas_estados, 2, function(columna)
    quantile(columna, 0.995))
  
}

```







